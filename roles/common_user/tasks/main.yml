---
- name: Add corresponding packages for our dotfiles
  ansible.builtin.apt:
    name:
      - bash
      - rsync
      - tmux
      - vim-nox
  become: true

- name: Create config directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: u=rwx,g=rwx,o=rx
  loop:
    - "{{ common_user_bash_aliases_dir }}"
    - "{{ common_user_bash_profile_dir }}"
    - "{{ common_user_tmux_config_dir }}"

- name: Source additional bash configurations
  ansible.builtin.blockinfile:
    path: "{{ ansible_user_dir }}/.profile"
    marker: "# [{{ role_name }}] {mark} ANSIBLE MANAGED BLOCK"
    block: |
      if [ -n "$BASH_VERSION" ]; then
          if [ -d $XDG_CONFIG_HOME/bash_profile ]; then
              pushd $XDG_CONFIG_HOME/bash_profile > /dev/null
              for file in $(ls); do
                  if [ -r $file ]; then
                     . ./$file
                  fi
              done
              popd > /dev/null
          fi
      fi

- name: Copy dotfiles to home directory
  ansible.builtin.template:
    src: "{{ item }}"
    dest: "{{ ansible_user_dir }}/.{{ item | basename | replace('.j2', '') }}"
    mode: u=rw,g=rw,o=r
  with_fileglob: "templates/dotfiles/*"
