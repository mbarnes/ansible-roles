#!/usr/bin/env -S ansible-playbook --ask-become-pass --ask-vault-pass
---
#
# Configures hosts in an inventory group named "desktop_group"
# consisting of pre-installed Debian GNU/Linux hoss with networking
# and SSH service available, and the remote user in the "sudo" group.
#
# Usage: ./desktop.yml [--limit HOSTS] [--tags TAGS]
#
# Available tags:
# - system        : Run all system-level tasks (as root)
# - user          : Run all user-level tasks
# - common_system : (system) Common System Configuration
# - boot          : (system) Boot and Login Configuration
# - lightdm       : (system,boot) Configure LightDM
# - plymouth      : (system,boot) Configure Plymouth
# - mta           : (system) Mail Transfer Agent (MTA) Configuration
# - common_user   : (user) Common User Configuration
# - desktop       : (user) Desktop Configuration
# - secrets       : (user) Transfer User Secrets
#

- name: Configure hosts for an XFCE desktop environment
  hosts: desktop_group

  vars:
    # Necessary for the secrets role because the password store repo is private.
    ansible_ssh_common_args: -o ForwardAgent=yes

  pre_tasks:

    - name: Check for necessary inventory variables
      ansible.builtin.assert:
        that: "item is defined"
        msg: "Missing required variables \"{{ item }}\". Please add this to your inventory."
      loop:
        - local_area_network
        - local_area_netmask
      tags:
        - always

  roles:

    # -----------------------------
    #  Common System Configuration
    # -----------------------------

    - role: common_system
      vars:
        common_system_extra_packages:
          - flatpak
      tags:
        - common_system
        - system

    # ------------------------------
    #  Boot and Login Configuration
    # ------------------------------

    - role: plymouth
      tags:
        - boot
        - plymouth
        - system

    - role: lightdm
      tags:
        - lightdm
        - system

    # -----------------------------------------
    #  Mail Transfer Agent (MTA) Configuration
    # -----------------------------------------

    - role: mta
      vars:
        mta_relay_user: mbarnes@fastmail.com
        mta_relay_host: smtp.fastmail.com
        mta_relay_pass: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          36333536313765613033653363626333336433643238343135626234663261613437346562626566
          6364633463666536353833343461613234363263643864660a633130356132393337376133386461
          65636336376665666363386633643466623436373665633932353162613066623939363666383434
          3139656536343031350a376136653236323064336634633130333637356361303563366430336363
          61326433626262343433383832336261366665363065353562633064333566613461
        mta_user_forward: mbarnes@fastmail.com
      tags:
        - mta
        - system

    # ---------------------------
    #  Common User Configuration
    # ---------------------------

    - role: common_user
      tags:
        - common_user
        - user

    - role: tmux
      tags:
        - common_user
        - user

    # -----------------------
    #  Desktop Configuration
    # -----------------------

    - role: desktop
      tags:
        - desktop
        - user

    # XXX Disabled until a package dependency bug is fixed:
    #     https://github.com/balena-io/etcher/issues/4543
    # - role: balena_etcher
    #   tags:
    #     - desktop
    #     - user

    # -----------------------
    #  Transfer User Secrets
    # -----------------------

    - role: secrets
      tags:
        - secrets
        - user

  tasks:

    - name: List manual follow-up tasks
      ansible.builtin.pause:
        prompt: |

          Additional tasks out of scope for this playbook:

            [ ] Sign in to Firefox account

        seconds: 1
      tags:
        - user
