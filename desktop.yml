#!/usr/bin/ansible-playbook
---
#
# Configures hosts in an inventory group named "desktop_group"
# consisting of pre-installed Debian GNU/Linux hoss with networking
# and SSH service available, and the remote user in the "sudo" group.
#
# Usage: ./desktop.yml --ask-become-pass
#
# Available tags:
# - system        : Run all system-level tasks (as root)
# - user          : Run all user-level tasks
# - common_system : (system) Common System Configuration
# - boot          : (system) Boot and Login Configuration
# - lightdm       : (system,boot) Configure LightDM
# - plymouth      : (system,boot) Configure Plymouth
# - common_user   : (user) Common User Configuration
# - desktop       : (user) Desktop Configuration
# - secrets       : (user) Transfer User Secrets
#

- name: Configure hosts for an XFCE desktop environment
  hosts: desktop_group

  vars:
    # Necessary for the secrets role because the password store repo is private.
    ansible_ssh_common_args: -o ForwardAgent=yes

  pre_tasks:

    - name: Check for necessary inventory variables
      ansible.builtin.assert:
        that: "item is defined"
        msg: "Missing required variables \"{{ item }}\". Please add this to your inventory."
      loop:
        - local_area_network
        - local_area_netmask
      tags:
        - always

  roles:

    # -----------------------------
    #  Common System Configuration
    # -----------------------------

    - role: common_system
      vars:
        common_system_extra_packages:
          - flatpak
      tags:
        - common_system
        - system

    # ------------------------------
    #  Boot and Login Configuration
    # ------------------------------

    - role: plymouth
      tags:
        - boot
        - plymouth
        - system

    - role: lightdm
      tags:
        - lightdm
        - system

    # ---------------------------
    #  Common User Configuration
    # ---------------------------

    - role: common_user
      tags:
        - common_user
        - user

    # -----------------------
    #  Desktop Configuration
    # -----------------------

    - role: desktop
      tags:
        - desktop
        - user

    # XXX Disabled until a package dependency bug is fixed:
    #     https://github.com/balena-io/etcher/issues/4543
    # - role: balena_etcher
    #   tags:
    #     - desktop
    #     - user

    # -----------------------
    #  Transfer User Secrets
    # -----------------------

    - role: secrets
      tags:
        - secrets
        - user

  tasks:

    - name: List manual follow-up tasks
      ansible.builtin.pause:
        prompt: |

          Additional tasks out of scope for this playbook:

            [ ] Sign in to Firefox account

        seconds: 1
      tags:
        - user
